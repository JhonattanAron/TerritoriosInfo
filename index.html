<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Formulario con SQLite (sin instalación)</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="container mt-5">
    <h2>Guardar datos en SQLite (sin instalación)</h2>
    <form id="dataForm">
      <div class="mb-3">
        <label class="form-label">Nombre</label>
        <input type="text" class="form-control" id="name" required />
      </div>
      <div class="mb-3">
        <label class="form-label">Edad</label>
        <input type="number" class="form-control" id="age" required />
      </div>
      <div class="mb-3">
        <label class="form-label">Email</label>
        <input type="email" class="form-control" id="email" required />
      </div>
      <button type="submit" class="btn btn-primary">Guardar</button>
    </form>

    <h3 class="mt-4">Datos Guardados</h3>
    <ul id="dataList" class="list-group"></ul>

    <script type="module">
      // Cargar SQLite desde un CDN
      import { sqlite3Worker1Promiser } from "https://cdn.jsdelivr.net/npm/@sqlite.org/sqlite-wasm/+esm";

      let dbPromiser, dbId;

      const log = console.log;
      const error = console.error;

      // Inicializar SQLite
      const initializeSQLite = async () => {
        try {
          console.log("Inicializando SQLite en OPFS...");

          dbPromiser = await new Promise((resolve) => {
            const promiser = sqlite3Worker1Promiser({
              onready: () => resolve(promiser),
            });
          });

          const openResponse = await dbPromiser("open", {
            filename: "file:mydb.sqlite3?vfs=opfs",
          });

          dbId = openResponse.dbId;
          console.log("Base de datos SQLite lista en OPFS.");

          // Crear la tabla de usuarios si no existe
          await dbPromiser("exec", {
            dbId,
            sql: `CREATE TABLE IF NOT EXISTS users (id INTEGER PRIMARY KEY AUTOINCREMENT, name TEXT, age INTEGER, email TEXT);`,
          });

          loadData(); // Cargar datos al iniciar
        } catch (err) {
          console.error("Error inicializando SQLite:", err);
        }
      };

      // Guardar los datos en la base de datos
      const saveData = async (name, age, email) => {
        try {
          await dbPromiser("exec", {
            dbId,
            sql: `INSERT INTO users (name, age, email) VALUES (?, ?, ?);`,
            bind: [name, age, email],
          });
          loadData(); // Recargar los datos guardados
        } catch (err) {
          console.error("Error al guardar:", err);
        }
      };

      // Cargar y mostrar los datos guardados
      const loadData = async () => {
        try {
          const result = await dbPromiser("exec", {
            dbId,
            sql: `SELECT * FROM users;`,
            rowMode: "array",
          });

          const dataList = document.getElementById("dataList");
          dataList.innerHTML = "";
          if (result.length > 0) {
            result[0].values.forEach((row) => {
              const li = document.createElement("li");
              li.classList.add("list-group-item");
              li.textContent = `ID: ${row[0]}, Nombre: ${row[1]}, Edad: ${row[2]}, Email: ${row[3]}`;
              dataList.appendChild(li);
            });
          }
        } catch (err) {
          console.error("Error al cargar datos:", err);
        }
      };

      // Ejecutar la inicialización y configurar el formulario
      document.addEventListener("DOMContentLoaded", async () => {
        await initializeSQLite();

        document
          .getElementById("dataForm")
          .addEventListener("submit", async (event) => {
            event.preventDefault();
            const name = document.getElementById("name").value;
            const age = document.getElementById("age").value;
            const email = document.getElementById("email").value;
            await saveData(name, age, email);
            event.target.reset();
          });
      });
    </script>
  </body>
</html>
